# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2017-present Team LibreELEC (https://libreelec.tv)

PKG_RKBIN="$(get_build_dir rkbin)"
PKG_SOC="rk356x"

UBOOT_CONFIG="rk3568_defconfig"
PKG_DATAFILE="$PKG_RKBIN/bin/rk35/rk3566_ddr_1056MHz_v1.08.bin"
PKG_LOADER="$PKG_RKBIN/bin/rk35/rk356x_spl_v1.11.bin"
PKG_LOAD_ADDR="0x0a100000"

if [ -n "$PKG_DATAFILE" -a -n "$PKG_LOADER" ]; then
  echo tools/mkimage -n ${PKG_SOC} -T rksd -d ${PKG_DATAFILE}:${PKG_LOADER} -C bzip2 idbloader.img
  pwd
  tools/mkimage -n ${PKG_SOC} -T rksd -d ${PKG_DATAFILE}:${PKG_LOADER} -C bzip2 idbloader.img
  cp -av idbloader.img $INSTALL/usr/share/bootloader
fi

echo "uboot: copy fit uboot image to ${INSTALL}/usr/share/bootloader..."
cp -av uboot.img ${INSTALL}/usr/share/bootloader

echo "boot: create boot.ini..."
  cat >${INSTALL}/usr/share/bootloader/boot.ini <<EOF
odroidgoa-uboot-config

setenv fdt_addr_r "0x01f00000"
setenv dtb_name "${DEVICE_DTB}.dtb"
setenv loadaddr "${PKG_LOAD_ADDR}"
setenv scriptaddr "0x00500000"
setenv kernel_addr_r "0x02008000"

sysboot mmc ${BOOT_PART} any \${scriptaddr} /extlinux/extlinux.conf

EOF


LE_TMP=$(mktemp -d)
mkdir -p "${LE_TMP}/extlinux" 
mkdir -p $INSTALL/usr/share/bootloader/extlinux

LINUX_DTS_DIR=$(get_build_dir linux)/.install_pkg/usr/share/bootloader
  for dtb in $(find $LINUX_DTS_DIR -name "*.dtb")
  do
cat << EOF > "${LE_TMP}/extlinux/$(basename ${dtb}).conf"
LABEL ${DISTRO_BOOTLABEL}
  LINUX /${KERNEL_NAME}
  FDT /$(basename ${dtb})
  APPEND boot=UUID=@BOOT_UUID@ disk=UUID=@DISK_UUID@ quiet ${EXTRA_CMDLINE}
EOF

cp -a "${LE_TMP}/extlinux/$(basename ${dtb}).conf" $INSTALL/usr/share/bootloader/extlinux
done
